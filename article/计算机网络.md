# 计算机网络的体系结构

目前一般用OSI模型或者TCP/IP模型来作为网络体系结构参考

OSI模型从下到上有七层：物理层 `physical layer`，数据链路层 `datalink layer`，网络层 `network layer`，传输层 `transport layer`，会话层 `session layer`，表示层 `presentation layer`，应用层 `application layer`

TCP/IP模型从下到上共有四层：网络接口层，网络层，传输层，应用层

为了方便理解，还有使用较多的五层混合模型，从下到上为：物理层，数据链路层，网络层，传输层，应用层

数据在网络传输中，需要经过各层，进行封装或解封装，封装过程大致如下：

- 应用层：生成原始数据（如HTTP请求）。
- 传输层：将数据加上TCP或UDP头部（包含端口号），形成段。
- 网络层：给段加上IP头部（包含源和目的IP地址），形成包。
- 数据链路层：给包加上帧头和帧尾（包含MAC地址和差错校验码），形成帧。
- 物理层：将帧转换为比特流，通过物理媒介发送出去。

解封装过程则是以相反的顺序进行

# Internet协议

## 网络层协议

### IP协议(Internet Protocol)

IP 协议是实现计算机间通信的重要协议

IP 协议为每个计算机分配一个 IP 地址，数据包传输路径由 IP 地址决定， IP 协议提供的是一个**无连接、不可靠**的服务

- 无连接：在发送数据包之前不需要建立连接，先发送的数据包不一定先到达

- 不可靠：IP协议不保证数据包的到达，没有确认和重传机制，因为种种原因可以被轻易的抛弃

#### IP数据报格式

IP 数据报由**首部**和**数据**两部分组成，数据是封装的部分与 IP 协议无关，在这里不予讨论，仅说明首部：

一般 IP 数据报首部为20byte，即160bit（“一般”指不带选项的首部），依顺序各个位置含义如下：

- 4bit：协议版本号，目前广泛使用的为IPv4

- 4bit：首部长度除以32（单位为bit），如160bit是32bit的5倍，则为5


- 8bit：服务类型（TOS），通过特定的数值来表明需要何种服务，控制最小时延、最大吞吐量等

- 16bit：数据报总长度，16bit意味着最大长度可以达到65535bit，注意这里指的是IP数据报，并不包括以太网首部或以太网尾部的长度

- 16bit：用于标识发送的报文，通常每发送一份报文该处加一

- 3bit：标志位，第一位为为保留位，第二位为DF（don’t fragment） ，为1指没有分片，第三位为MF（more fragment），为1指有分片（因为数据报最大传输长度的限制，如果有极大的数据报，则需要分开传输，即分片）

- 13bit：分片的偏移量

- 8bit：TTL（time to live），每经过一个路由器该值减一，如果一个路由器收到该值为零的数据报，路由器丢弃该报文，并发送ICMP报文给源主机

- 8bit：用于标识上层协议

- 16bit：首部检验和。

- 32bit：源IP地址

- 32bit：目的IP地址

如有选项，选项的长度需为32bit的倍数，必要时用0填充

#### IP协议功能

- 寻址：IP 协议通过 IP 地址 来唯一标识网络上的每一台主机。IPv4 使用 32 位地址， IPv6 使用 128 位地址

- 路由：路由器通过内部的路由表，根据数据包的目的 IP 地址，为每个包选择一条最佳的路径，将其转发到下一个路由器（下一跳），直到到达最终目的地

- 分片与重组：不同的物理网络有不同的最大传输单元（MTU），即一帧能携带的最大数据量。当一个 IP 数据报的大小超过下一段网络的 MTU 时，路由器会将其分割成多个较小的分片。每个分片都有自己的 IP 首部（大部分字段相同，但分片相关字段不同），所有分片独立传输，只在最终的目的主机上进行重组，还原成原始的数据报。

#### IP地址与网络掩码

对于 IPv4 地址来说，是用 32 位二进制数字表示，每 8 位用 `.` 隔开，例如 `192.168.0.1` （接下来所有例子都将使用这个 IP ）

其中一部分代表网络号，一部分代表主机号，区别网络号和主机号的办法就是网络掩码

网络掩码是由连续的多个 `1` 和连续的多个 `0` 组成的 32 位二进制代码用来与 IP 地址一 一对应，与 `1` 对应的就是网络号，与 `0` 对应的就是主机号。

例如掩码 `255.255.255.0` ，表示 IP 地址的前 24 位为网络号，后 8 位为主机号

为了更简洁地表示网络掩码，我们常用 CIDR表示法，格式为 `IP地址 / 网络号的位数` , 例如 `192.168.0.1/24`

##### 特殊地址

已知 `192.168.0.1/24` 

- 网络地址为 `192.168.0.0`  *主机号全部置0*

- 广播地址为 `192.168.0.1` *主机号全部置1* **广播地址可用于往向网络内的所有主机发送数据包**

### ICMP协议(Internet Control Message Protocol)

ICMP 协议是一个辅助协议，与 IP 协议协同工作。传输数据时作为数据载荷封装在 IP 数据报中，主要用于管理网络层和诊断通信状态而非通信

#### ICMP安全

- 大量发送 ICMP 数据报来形成 DDOS 攻击

- 伪造 ICMP 数据报来劫持流量

### OSPF协议(Open Shortest Path First)

OSPF 协议属于**内部网关协议**，是一种**链路状态路由协议**

### RIP协议(Routing Information Protocol)

RIP 协议属于**内部网关协议**，是一种**距离矢量路由协议**

### BGP协议(Border Gateway Protocol)

BGP 协议又叫**边界网关协议**，属于**外部网关协议**，是一种**路径矢量路由协议**

### IGMP协议

### ARP协议




## 传输层协议


## 应用层协议

### DNS协议(Domain Name System)

DNS协议的主要作用是将便于人类记忆的域名解析为计算机通信需要使用的IP地址，通常使用53端口

接下来以一个例子来阐述DNS的工作过程：

- 在浏览器输入 `www.baidu.com` ，点击访问，此时需要获取 `wwww.baidu.com` 的IP地址，浏览器首先检查自己的缓存中是否有对应的IP地址

- 如果浏览器缓存中没有，则操作系统检查本地缓存和 `hosts` 文件是否有对应 IP 地址

- 如果依旧没有，那么就会向 DNS 服务发出解析请求，DNS服务器通常由 ISP 服务商提供，也可以由用户自行规定 DNS 服务器地址


DNS 服务器并非一个无比庞大的中央数据库服务器，而是一个层次化的数据库，由各种不同功能的分布式服务器来实现用户的查询。DNS 服务器中有根域名服务器、顶级域名服务器等等。全球有 13 台根域名服务器，又这些服务器授权的 DNS 服务器叫做权威服务器。

当查询 `www.baidu.com` 时，首先向根域名服务器发出解析请求，根域名服务器会返回一个 com 顶级域名服务器的地址

接着我们向 com 顶级域名服务器发出请求，com 域名服务器返回 baidu.com 域名服务器地址

接着继续向 baidu.com 域名服务器地址发出请求，最终得到 www.baidu.com 的 IP 地址

*由此可见 DNS 查询是一个迭代查询的过程*

#### DNS记录类型

虽然DNS的职责是映射域名和IP地址，但其记录却不止这么简单，DNS记录有多种类型：

- A 记录：最基础记录，将域名指向一个 IPv4 地址

- AAAA 记录：将域名指向一个 IPv6 地址

- CNAME 记录：别名记录，将一个域名指向另一个域名

- MX 记录：邮件交换记录，指定负责接收该域名邮件的服务器

- NS 记录：域名服务器记录，指定该域名由哪个权威 DNS 服务器负责解析

- TXT 记录：文本记录，常用于存放 SPF 信息（反垃圾邮件）、域名所有权验证等

#### DNS安全

- DNS 污染 / 投毒，：存在伪造的 DNS 数据，用户无法得到正确 IP 地址

- DNS 劫持：伪造 DNS 数据，将用户导向其他 IP

### SMTP协议 ( Simple Mail Transfer Protocol ) - 简单邮件传输协议

SMTP 协议是用于发送和转发电子邮件的核心协议

- SMTP 是一个 **推** 协议，用于将邮件从客户端 " 推 " 送到服务器，或在服务器之间 " 推 " 送，它不用于从服务器“拉取”邮件

- 基于TCP 连接，确保数据传输的可靠性

- 默认端口：

    - 25：传统的、用于服务器间转发的端口，由于垃圾邮件和安全性问题，现在很多ISP会封锁此端口

    - 587：推荐的邮件提交端口。要求使用 STARTTLS 进行加密，并且通常需要身份验证，这是现代邮件客户端发送邮件时使用的端口

    - 465：历史上用于 SMTPS（SMTP over SSL），后来被弃用，但现在又被广泛用于隐式 SSL/TLS 连接

SMTP通信过程：连接 -> 握手 / 加密 -> 认证 -> 声明收发人 -> 传输数据 -> 断开连接


### 